@page "/members"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Authorization
@using TAGCRM.Models
@using TAGCRM.Services
@attribute [Authorize]
@inject MemberService MemberService
@inject ContactService ContactService
@inject NavigationManager Navigation

<PageTitle>Members - Trade Alliance Group</PageTitle>

<div class="container-fluid page-container-section mb-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="page-title">Members</h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" class="form-control search-bar-input"
                    placeholder="Search Business Name, Member ID, Phone, Email" @bind="searchTerm" @bind:event="oninput"
                    @onkeyup="OnSearchKeyUp">
                <button class="input-group-text search-bar-logo" @onclick="PerformSearch">
                    <i class="bi bi-search"></i>
                </button>
            </div>
            <div class="">
                <button @onclick='() => Navigation.NavigateTo("/members/new")'
                    class="btn btn-primary create-record-button mobile-button">+ New Member</button>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <button @onclick='() => Navigation.NavigateTo("/members/new")'
                class="btn btn-primary create-record-button desktop-button">+ New Member</button>
        </div>
    </div>

    @if (members.Any())
    {
        <div class="table-container">
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th style="width: 10%;" class="text-center">Active</th>
                        <th style="width: 20%; white-space: nowrap;">Business Name</th>
                        <th style="width: 10%; white-space: nowrap;">Member ID</th>
                        <th style="width: 20%; white-space: nowrap;">Primary Contact</th>
                        <th style="width: 15%; white-space: nowrap;">Phone</th>
                        <th style="width: 25%; white-space: nowrap;">Email</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var member in members)
                    {
                        <tr style="cursor: pointer;" @onclick='() => Navigation.NavigateTo($"/members/{member.Id}")'>
                            <td class="text-center">
                                @if (member.Active)
                                {
                                    <i class="bi bi-circle-fill text-success"></i>
                                }
                                else
                                {
                                    <i class="bi bi-circle-fill text-danger"></i>
                                }
                            </td>
                            <td class="text-dark">@member.BusinessName</td>
                            <td class="text-dark">@member.MemberId</td>
                            <td class="text-dark">@GetPrimaryContactName(member.PrimaryContactId)</td>
                            <td class="text-dark">@member.Phone</td>
                            <td class="text-dark">@member.Email</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (totalPages > 1)
        {
            <div class="row mt-4 mb-4">
                <div class="col-12 d-flex justify-content-center">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                @if (currentPage == 1)
                                {
                                    <span class="page-link">«</span>
                                }
                                else
                                {
                                    <button type="button" class="page-link"
                                        @onclick='() => NavigateToPage(currentPage - 1)'>«</button>
                                }
                            </li>

                            @for (int i = 1; i <= totalPages; i++)
                            {
                                int pageNum = i;
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    @if (i == currentPage)
                                    {
                                        <span class="page-link">@i</span>
                                    }
                                    else
                                    {
                                        <button type="button" class="page-link" @onclick='() => NavigateToPage(pageNum)'>@i</button>
                                    }
                                </li>
                            }

                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                @if (currentPage == totalPages)
                                {
                                    <span class="page-link">»</span>
                                }
                                else
                                {
                                    <button type="button" class="page-link"
                                        @onclick='() => NavigateToPage(currentPage + 1)'>»</button>
                                }
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    }
    else if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No members found.
        </div>
    }
</div>

@code {
    private List<Member> members = new();
    private List<Contact> contacts = new();
    private bool isLoading = true;
    private string searchTerm = "";

    private int currentPage = 1;
    private int pageSize = 10;
    private int totalRecords = 0;
    private int totalPages => (int)Math.Ceiling((double)totalRecords / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async void PerformSearch()
    {
        currentPage = 1;
        await LoadData();
        StateHasChanged();
    }

    private void OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            PerformSearch();
        }
    }

    private async void NavigateToPage(int page)
    {
        currentPage = page;
        await LoadData();
        StateHasChanged();
    }

    private string GetPrimaryContactName(int? primaryContactId)
    {
        if (!primaryContactId.HasValue || primaryContactId.Value <= 0)
            return "N/A";

        var c = contacts.FirstOrDefault(x => x.Id == primaryContactId.Value);
        if (c is null) return "Unknown";

        var name = ComputeContactName(c);
        // Fallbacks if name fields are empty
        if (string.IsNullOrWhiteSpace(name))
            name = !string.IsNullOrWhiteSpace(c.Email) ? c.Email
            : !string.IsNullOrWhiteSpace(c.Phone) ? c.Phone
            : $"Contact #{c.Id}";

        return name;
    }

    private static string ComputeContactName(Contact c)
    {
        // Use PreferredName if present, otherwise FirstName
        var first = (string.IsNullOrWhiteSpace(c.PreferredName) ? c.FirstName : c.PreferredName)?.Trim() ?? "";
        var last  = (c.Surname ?? "").Trim();

        var full = string.Join(" ", new[] { first, last }.Where(s => !string.IsNullOrWhiteSpace(s)));
        if (!string.IsNullOrWhiteSpace(full)) return full;

        // Fallbacks if both names are empty
        if (!string.IsNullOrWhiteSpace(c.Email)) return c.Email;
        if (!string.IsNullOrWhiteSpace(c.Phone)) return c.Phone;
        return $"Contact #{c.Id}";
    }

    private async Task LoadData()
    {
        isLoading = true;

        try
        {
            // Load contacts first to resolve primary contact names
            contacts = await ContactService.GetAllContactsAsync();

            // Load members with pagination and search
            var result = await MemberService.GetMembersAsync(currentPage, pageSize, searchTerm);
            members = result.Data;
            totalRecords = result.TotalRecords;
        }
        catch
        {
            members = new List<Member>();
            contacts = new List<Contact>();
            totalRecords = 0;
        }

        isLoading = false;
    }
}